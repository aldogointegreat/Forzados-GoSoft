
CREATE TABLE [dbo].[MAE_PUESTO_RIESGO2](
	[PUESTO_RIESGO_ID] [int] IDENTITY(1,1) NOT NULL,
	[PUESTO_ID] [int] NOT NULL,
	[RIESGO_ID] [int] NOT NULL,
	[USUARIO_CREACION] [varchar](20) NULL,
	[FECHA_CREACION] [datetime] NULL,
	[USUARIO_MODIFICACION] [varchar](20) NULL,
	[FECHA_MODIFICACION] [datetime] NULL,
	[ESTADO] [int] NULL)




CREATE TRIGGER TR_MAE_PUESTO_AfterAllEvents
ON MAE_PUESTO
AFTER  UPDATE, DELETE
AS
BEGIN
    -- Truncar la tabla MAE_PUESTO_RIESGO2 para refrescar todos los datos
    TRUNCATE TABLE MAE_PUESTO_RIESGO2;

    -- Insertar datos en MAE_PUESTO_RIESGO2 basados en los registros actuales de MAE_PUESTO
    INSERT INTO MAE_PUESTO_RIESGO2 (PUESTO_ID, RIESGO_ID, USUARIO_CREACION, FECHA_CREACION, USUARIO_MODIFICACION, FECHA_MODIFICACION, ESTADO)
    SELECT 
        mp.PUESTO_ID,
        r.RIESGO_ID,
        mp.USUARIO_CREACION,
        mp.FECHA_CREACION,
        mp.USUARIO_MODIFICACION,
        mp.FECHA_MODIFICACION,
        mp.ESTADO
    FROM MAE_PUESTO mp
    CROSS APPLY (
        SELECT TRIM(value) AS value
        FROM STRING_SPLIT(mp.NIVEL_RIESGO_APROBACION, ',') -- Usamos coma como delimitador
    ) rm
    INNER JOIN RIESGO r ON TRIM(rm.value) = r.DESCRIPCION
    WHERE mp.NIVEL_RIESGO_APROBACION IS NOT NULL
    AND r.ESTADO = 1;

    -- Depuración: Verificar los valores descompuestos
    PRINT 'Valores descompuestos:';
    SELECT 
        mp.PUESTO_ID,
        TRIM(rm.value) AS NIVEL_RIESGO_APROBACION
    FROM MAE_PUESTO mp
    CROSS APPLY (
        SELECT TRIM(value) AS value
        FROM STRING_SPLIT(mp.NIVEL_RIESGO_APROBACION, ',') -- Mismo split que en el INSERT
    ) rm
    WHERE mp.NIVEL_RIESGO_APROBACION IS NOT NULL;

    -- Mensaje de depuración con el número de filas insertadas
    DECLARE @RowCount INT;
    SET @RowCount = @@ROWCOUNT;
    PRINT 'Número de filas insertadas: ' + CAST(@RowCount AS VARCHAR(10));
END;


   

	EXEC sp_rename 'TRS_SOLICITUD_FORZADO.FECHA_CREACION', 'FECHA_CREACION_A', 'COLUMN';
	EXEC sp_rename 'TRS_SOLICITUD_FORZADO.USUARIO_CREACION', 'USUARIO_CREACION_A', 'COLUMN';
	EXEC sp_rename 'TRS_SOLICITUD_FORZADO.FECHAEJECUCION_A', 'FECHA_EJECUCION_A', 'COLUMN';
	EXEC sp_rename 'TRS_SOLICITUD_FORZADO.FECHAEJECUCION_B', 'FECHA_EJECUCION_B', 'COLUMN';

	ALTER TABLE dbo.[TRS_SOLICITUD_FORZADO]
	ADD FECHA_APROBACION_A DATETIME null;

	ALTER TABLE dbo.[TRS_SOLICITUD_FORZADO]
    ADD FECHA_CREACION_B DATETIME null;

    ALTER TABLE MAE_TAGS_MATRIZ_RIESGO
  ADD TAG_CONCAT varchar(20);

    ALTER TABLE MAE_TAGS_MATRIZ_RIESGO
  ADD DESCRIPCION varchar(50);

	ALTER TABLE dbo.[TRS_SOLICITUD_FORZADO]
    ADD FECHA_APROBACION_B DATETIME null;

	ALTER TABLE dbo.[TRS_SOLICITUD_FORZADO]
    ADD FECHA_RECHAZO_A DATETIME null;

	ALTER TABLE dbo.[TRS_SOLICITUD_FORZADO]
    ADD USUARIO_RECHAZO_A INT null;

	ALTER TABLE dbo.[TRS_SOLICITUD_FORZADO]
    ADD FECHA_RECHAZO_B DATETIME null;

	ALTER TABLE dbo.[TRS_SOLICITUD_FORZADO]
    ADD USUARIO_RECHAZO_B INT null;

	ALTER TABLE dbo.[TRS_SOLICITUD_FORZADO]
    ADD FECHA_OBSERVACION_A DATETIME null;

	ALTER TABLE dbo.[TRS_SOLICITUD_FORZADO]
    ADD USUARIO_OBSERVACION_A INT null;

 
 UPDATE MAE_PUESTO SET NIVEL_RIESGO_APROBACION = ''





EXEC sp_rename 'TRS_SOLICITUD_FORZADO.GRUPO', 'GRUPO_A', 'COLUMN';

		ALTER TABLE dbo.[TRS_SOLICITUD_FORZADO]
		ADD GRUPO_B INT null;


21/03/2025
	ALTER TABLE dbo.[TRS_SOLICITUD_FORZADO]
    ADD ULTIMO_CORREO_ENVIADO DATETIME;

	ALTER TABLE dbo.[TRS_SOLICITUD_FORZADO]
    ADD FECHA_FIN_PLANIFICADA DATETIME;
        ---------------------------

 CREATE TABLE MAE_TOLERANCIA (
    TOLERANCIA_ID INT PRIMARY KEY IDENTITY(1,1),           -- Identificador único autoincremental
    PORCENTAJE_TOLERANCIA DECIMAL(5,2) NOT NULL,          -- Porcentaje de tolerancia (máx. 999.99, 2 decimales)
    INTERVALO INT NOT NULL,                               -- Intervalo en horas para el envío de correos
    FECHA_MODIFICACION DATETIME DEFAULT GETDATE(),        -- Fecha de última modificación, por defecto la fecha actual
    CONSTRAINT CHK_PORCENTAJE_TOLERANCIA CHECK (PORCENTAJE_TOLERANCIA BETWEEN 0 AND 100), -- Restricción para porcentaje
    CONSTRAINT CHK_INTERVALO CHECK (INTERVALO > 0)        -- Restricción para que el intervalo sea positivo
);

24/03/2025

ALTER TABLE MAE_USUARIO 
ALTER COLUMN DNI VARCHAR(20)


25/03/2025
----------------------
	
ALTER TABLE [dbo].[RESPONSABLE]
ALTER COLUMN NOMBRE varchar(200)
GO

	CREATE TABLE [dbo].[MAE_CIRCUITO](
	[CIRCUITO_ID] [int] IDENTITY(1,1) NOT NULL,
	[DESCRIPCION] [varchar](100) NULL,
	[ESTADO] [int] NULL,
	[USUARIO_CREACION] [varchar](20) NULL,
	[FECHA_CREACION] [datetime] NULL,
	[USUARIO_MODIFICACION] [varchar](20) NULL,
	[FECHA_MODIFICACION] [datetime] NULL,
 CONSTRAINT [PK_MAE_CIRCUITO] PRIMARY KEY CLUSTERED 
 (
  	[CIRCUITO_ID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, 
ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO

ALTER TABLE [dbo].[TRS_SOLICITUD_FORZADO]  WITH CHECK ADD  CONSTRAINT [FK_TRS_SOLI_REFERENCE_MAE_CIRCUITO] FOREIGN KEY([CIRCUITO_ID])
REFERENCES [dbo].[MAE_CIRCUITO] ([CIRCUITO_ID])
GO



ALTER TABLE [dbo].[TRS_SOLICITUD_FORZADO]
ADD  [CIRCUITO_ID] int;
GO




-------------

26/03

  ALTER TABLE MAE_TOLERANCIA
DROP CONSTRAINT CHK_INTERVALO;

ALTER TABLE [dbo].[TRS_SOLICITUD_FORZADO]
ALTER COLUMN [DESCRIPCIONFORZADO] VARCHAR(200)
GO


16/04

CREATE TABLE MAE_PUESTO_TURNO (
  PUESTO_ID INT NOT NULL,
  TURNO_ID INT NOT NULL,
  USUARIO_CREACION VARCHAR(20) NOT NULL,
  FECHA_CREACION DATETIME NOT NULL,
  USUARIO_MODIFICACION VARCHAR(20) NOT NULL,
  FECHA_MODIFICACION DATETIME NOT NULL,
  CONSTRAINT PK_MAE_PUESTO_TURNO PRIMARY KEY (PUESTO_ID, TURNO_ID),
  CONSTRAINT FK_PUESTO_TURNO_PUESTO FOREIGN KEY (PUESTO_ID) REFERENCES MAE_PUESTO(PUESTO_ID),
  CONSTRAINT FK_PUESTO_TURNO_TURNO FOREIGN KEY (TURNO_ID) REFERENCES TURNO(TURNO_ID)
);



----------
	CREATE TABLE dbo.HORARIO_TRABAJO (
    HORARIO_ID INT PRIMARY KEY IDENTITY(1,1),
    DESCRIPCION VARCHAR(255) NOT NULL,
    HORA_INICIO TIME(7) NOT NULL,
    USUARIO_CREACION VARCHAR(20) NULL,
    FECHA_CREACION DATETIME NULL,
    USUARIO_MODIFICACION VARCHAR(20) NULL,
    FECHA_MODIFICACION DATETIME NULL,
    ESTADO INT NOT NULL DEFAULT 1
    )
---

ALTER TABLE TURNO
ADD HORA_INICIO TIME NULL;

ALTER TABLE TURNO
ADD HORA_FIN TIME NULL;


----04/05/2025
	ALTER TABLE MAE_TAGS_MATRIZ_RIESGO
		ADD INTERLOCK INT  

		ALTER TABLE MAE_TAGS_MATRIZ_RIESGO
		ADD RIESGO_A INT 


----15/05/2025
        ALTER TABLE TRS_SOLICITUD_FORZADO
		ADD  OBSERVACION_EJECUCION_A VARCHAR(200) 

		ALTER TABLE TRS_SOLICITUD_FORZADO
		ADD  DESCRIPCION_EJECUCION_A VARCHAR(200)
        
		ALTER TABLE TRS_SOLICITUD_FORZADO
		ADD  DESCRIPCION_EJECUCION_B VARCHAR(200) 

----
2/06/2025


alter table TRS_SOLICITUD_FORZADO
ADD FECHA_OBSERVACION_B DATETIME ;


alter table TRS_SOLICITUD_FORZADO
ADD USUARIO_OBSERVACION_B INT ;

alter table TRS_SOLICITUD_FORZADO
ADD OBSERVACION_EJECUCION_B VARCHAR(200) ;


---
alter table TRS_SOLICITUD_FORZADO
ADD OBSERVACION_APROBACION_B VARCHAR(200) ;

alter table TRS_SOLICITUD_FORZADO
ADD USUARIO_OBSERVACION_APROBACION_B VARCHAR(200) ;

alter table TRS_SOLICITUD_FORZADO
ADD FECHA_OBSERVACION_APROBACION_B DATETIME ;

--- 01/07/2025
ALTER TABLE MAE_DATO_ADJUNTO
ADD ETAPA_DOCUMENTO varchar(200)