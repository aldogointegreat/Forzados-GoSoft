name: Mirror to Azure DevOps

on:
  push:
    branches: [ "**" ]
    tags:     [ "**" ]
  delete:
  create:

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Mirror to Azure (strict 1:1)
        env:
          # URL del repo en ADO (la tuya)
          AZ_URL_READONLY: https://dev.azure.com/GIGTeam/GIGDailyMeeting/_git/Forzados%20GoSoft
          AZ_URL_WITH_AUTH: https://ado:${{ secrets.AZURE_DEVOPS_PAT }}@dev.azure.com/GIGTeam/GIGDailyMeeting/_git/Forzados%20GoSoft
        run: |
          set -e

          # Opcional: mitigar issues de red en runners
          git config http.version HTTP/1.1
          git config http.postBuffer 524288000

          # Remoto limpio y agregado con PAT embebido (usuario 'ado' sin @)
          git remote remove azure 2>/dev/null || true
          git remote add azure "$AZ_URL_WITH_AUTH"

          # Reintentos simples por si hay flakiness
          n=0
          until [ $n -ge 3 ]; do
            git push azure --mirror && break
            n=$((n+1))
            echo "Retry $n/3 in 5s..."
            sleep 5
          done

          # Seguridad: quitar el token del remoto
          git remote set-url azure "$AZ_URL_READONLY"
