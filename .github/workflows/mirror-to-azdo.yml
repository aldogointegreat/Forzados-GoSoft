name: Mirror to Azure DevOps

on:
  push:
    branches: [ "**" ]
    tags:     [ "**" ]
  delete:
  create:

env:
  AZ_ORG: GIGTeam
  AZ_PROJECT: GIGDailyMeeting
  AZ_REPO_ENC: Forzados%20GoSoft   # nombre del repo URL-encoded

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Mirror to Azure (strict 1:1)
        shell: bash
        run: |
          # 1) Remoto sin credenciales en la URL
          git remote add azure "https://dev.azure.com/${AZ_ORG}/${AZ_PROJECT}/_git/${AZ_REPO_ENC}"

          # 2) Cabecera Authorization (usuario vacío ":" + PAT) → evita problemas con emails con '@'
          AUTH=$(printf ":%s" "${{ secrets.AZURE_DEVOPS_PAT }}" | base64)
          git config http.https://dev.azure.com/.extraheader "AUTHORIZATION: Basic $AUTH"

          # 3) Espejo exacto (todas las refs, forzado, incluye borrados)
          git push azure --mirror

          # 4) Limpieza de la cabecera
          git config --unset-all http.https://dev.azure.com/.extraheader || true
